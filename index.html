<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mountain Lion Connectivity – ArcGIS Pro Corridor Model</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Mapbox GL JS -->
  <link
    href="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.css"
    rel="stylesheet"
  />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: #111;
      color: #f5f5f5;
    }

    #page {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      padding: 1rem;
      text-align: center;
      background: #222;
      border-bottom: 1px solid #333;
    }

    main {
      flex: 1;
      padding: 1rem;
      max-width: 1200px;
      margin: 0 auto;
      box-sizing: border-box;
    }

    h1 {
      margin: 0;
      font-size: 1.6rem;
    }

    h2 {
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
      font-size: 1.2rem;
    }

    h3 {
      margin-top: 1.2rem;
      margin-bottom: 0.4rem;
      font-size: 1.05rem;
    }

    p {
      margin-top: 0.25rem;
      margin-bottom: 0.75rem;
      color: #ddd;
    }

    ul {
      margin-top: 0.25rem;
    }

    .map-box {
      width: 100%;
      height: 450px;
      border-radius: 8px;
      border: 1px solid #444;
      overflow: hidden;
      position: relative;
      margin-top: 0.5rem;
      background: #000;
    }

    #main-map,
    #distance-map {
      width: 100%;
      height: 100%;
    }

    .map-overlay {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 2;
      background: rgba(0, 0, 0, 0.8);
      color: #f5f5f5;
      padding: 8px 10px;
      border-radius: 6px;
      font-size: 13px;
      line-height: 1.4;
      max-width: 240px;
    }

    .map-overlay strong {
      display: block;
      margin-bottom: 4px;
    }

    .map-overlay label {
      display: block;
      cursor: pointer;
      margin-bottom: 4px;
      user-select: none;
    }

    .input-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 1rem;
      margin-top: 0.5rem;
    }

    figure {
      margin: 0;
      background: #181818;
      border-radius: 8px;
      border: 1px solid #333;
      padding: 0.5rem 0.5rem 0.75rem;
    }

    figure img {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 4px;
    }

    figure figcaption {
      margin-top: 0.35rem;
      font-size: 0.9rem;
      color: #ccc;
    }

    .legend {
      margin-top: 0.4rem;
      font-size: 0.85rem;
    }

    .legend-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 2px;
    }

    .legend-swatch {
      width: 14px;
      height: 14px;
      border-radius: 2px;
      margin-right: 6px;
      flex-shrink: 0;
      border: 1px solid rgba(0,0,0,0.4);
    }
  </style>
</head>
<body>
  <div id="page">
    <header>
      <h1>Mountain Lion Connectivity – ArcGIS Pro Corridor Model</h1>
      <p style="margin:0.25rem 0 0;">
        Connectivity model built by reproducing Esri’s “Build a Model to Connect Mountain Lion Habitat”
        workflow in ArcGIS Pro (Spatial Analyst + ModelBuilder), then published as Mapbox web maps.
      </p>
    </header>

    <main>
      <!-- MAIN MAP -->
      <section>
        <h2>Main Connectivity Map</h2>
        <p>
          This map shows a composite cost surface (green → yellow → red) under a least-cost wildlife corridor
          connecting core mountain lion habitats in the mountains northwest of Los Angeles. Corridors matter
          because they restore functional connectivity between isolated habitat patches, reduce road-kill
          risk at major highways, and maintain gene flow so small, fragmented populations don’t collapse
          through inbreeding.
        </p>
        <p>
          The underlying cost surface weights four criteria derived in ArcGIS Pro: distance from roads,
          legal protection status, rugged terrain, and dense land cover. Least-cost paths are then traced
          across this cost surface to identify candidate overpass locations and priority parcels for
          protection.
        </p>

        <div class="map-box">
          <div id="main-map"></div>

          <div id="layer-controls-main" class="map-overlay">
            <strong>Main layers</strong>
            <label>
              <input type="checkbox" id="toggle-cost" checked />
              Cost raster
            </label>
            <label>
              <input type="checkbox" id="toggle-corridor" checked />
              Corridor
            </label>
            <label>
              <input type="checkbox" id="toggle-habitat" checked />
              Core habitats
            </label>
            <label>
              <input type="checkbox" id="toggle-habitat-labels" checked />
              Habitat labels
            </label>
          </div>
        </div>
      </section>

      <!-- ARC PRO WORKFLOW SUMMARY -->
      <section>
        <h2>How this corridor model was built in ArcGIS Pro</h2>
        <p>
          This map is the result of implementing Esri’s Learn ArcGIS project
          <em>“Build a Model to Connect Mountain Lion Habitat”</em> in ArcGIS Pro. The core of the workflow
          is an ArcGIS Pro ModelBuilder model that chains Spatial Analyst tools into a reproducible
          corridor-analysis pipeline:
        </p>
        <ul>
          <li>
            <strong>Study area and core habitats.</strong> Start from an Esri-provided ArcGIS Pro project
            containing the Los Angeles study area and polygon features for core mountain lion habitats.
            Review elevation, land cover, roads, and protected status layers as corridor criteria.
          </li>
          <li>
            <strong>Pre-processing in ModelBuilder.</strong> In a “Prepare data” group, derive analysis
            inputs using tools like <em>Rasterize Features</em> and <em>Euclidean Distance</em> or
            <em>Distance Accumulation</em> for roads, and compute a terrain ruggedness surface from the
            elevation DEM. All rasters are snapped to a common extent and cell size.
          </li>
          <li>
            <strong>Cost surface generation.</strong> In a “Create cost surface” group, each criterion
            (distance to roads, land cover, protection status, ruggedness) is normalized to a 0–1 or
            1–10 scale using <em>Rescale by Function</em> and <em>Reclassify</em>. A weighted linear
            combination is then applied via <em>Weighted Sum</em> or <em>Raster Calculator</em> to
            produce a single composite cost raster where low values correspond to easy movement for lions.
          </li>
          <li>
            <strong>Least-cost corridor extraction.</strong> The composite cost surface and core habitat
            polygons are fed into the <em>Optimal Region Connections</em> tool to compute least-cost
            paths between regions, returning a primary “Mountain_Lion_Paths” line network and optional
            neighbor-to-neighbor alternatives. These paths define the backbone wildlife corridor(s).
          </li>
          <li>
            <strong>Evaluation and export.</strong> The resulting cost surface and corridor network are
            symbolized in ArcGIS Pro, checked against roads and land-use conflicts, and then exported and
            tiled for web visualization here using Mapbox GL JS.
          </li>
        </ul>
        <p>
          The end result is a defensible, tool-driven corridor model that can be re-run with different
          weights or criteria by simply re-executing the ModelBuilder workflow on new inputs.
        </p>
      </section>

      <!-- INPUTS SECTION -->
      <section>
        <h2>Input Layers</h2>
        <p>
          These are the main inputs that feed into the ArcGIS Pro cost-surface and corridor model:
          distance to roads, land cover classes, and protected areas.
        </p>

        <!-- Distance to roads map -->
        <h3>1. Distance to roads (Mapbox tiles, derived from ArcGIS Pro)</h3>
        <p>
          This map shows a distance-to-roads raster surface with a simplified roads network overlaid.
          In the underlying ArcGIS Pro model, raw roads features are rasterized and converted to a
          continuous distance surface; that distance is then rescaled so areas very close to roads
          are high-cost for lions and more remote terrain is low-cost. Here the raster is used as a
          continuous background, with the vector roads overlay highlighting the infrastructure that
          fragments habitat.
        </p>

        <div class="map-box">
          <div id="distance-map"></div>

          <div id="layer-controls-distance" class="map-overlay">
            <strong>Distance map layers</strong>
            <label>
              <input type="checkbox" id="toggle-roads" checked />
              Roads overlay
            </label>
          </div>
        </div>

        <!-- Static images for Land cover + Protected areas -->
        <h3 style="margin-top:1.5rem;">2. Land cover and protected areas (static inputs)</h3>
        <p>
          These PNGs are exported directly from the ArcGIS Pro project. They represent the categorical
          inputs that were reclassified and weighted in the cost surface: land cover (NLCD-based classes)
          and legal protection status of land parcels.
        </p>

        <div class="input-grid">
          <figure>
            <img src="Land_cover.png" alt="Land cover classes" />
            <figcaption>
              Land cover classes used as one of the primary cost criteria. Forested and shrub habitats
              tend to be lower cost (more suitable for movement), while highly developed or intensively
              cultivated lands are higher cost.
            </figcaption>

            <!-- Land cover legend -->
            <div class="legend">
              <div class="legend-title">Land cover legend</div>

              <div class="legend-item">
                <span class="legend-swatch" style="background:#e31a1c;"></span>
                <span>Evergreen Forest</span>
              </div>
              <div class="legend-item">
                <span class="legend-swatch" style="background:#1dd3e6;"></span>
                <span>Deciduous Forest / Mixed Forest</span>
              </div>
              <div class="legend-item">
                <span class="legend-swatch" style="background:#00c8b4;"></span>
                <span>Shrub/Scrub/Herbaceous</span>
              </div>
              <div class="legend-item">
                <span class="legend-swatch" style="background:#ffd92f;"></span>
                <span>Hay/Pasture/Woody Wetlands / Emergent Herbaceous Wetlands</span>
              </div>
              <div class="legend-item">
                <span class="legend-swatch" style="background:#ff7f00;"></span>
                <span>Barren Land / Cultivated Crops</span>
              </div>
              <div class="legend-item">
                <span class="legend-swatch" style="background:#6b6bb5;"></span>
                <span>Developed, Low Intensity</span>
              </div>
              <div class="legend-item">
                <span class="legend-swatch" style="background:#a6d96a;"></span>
                <span>Developed, Open Space / Medium Intensity</span>
              </div>
              <div class="legend-item">
                <span class="legend-swatch" style="background:#ff00ff;"></span>
                <span>Developed, High Intensity</span>
              </div>
              <div class="legend-item">
                <span class="legend-swatch" style="background:#54278f;"></span>
                <span>Open Water</span>
              </div>
            </div>
          </figure>

          <figure>
            <img src="Protected_areas.png" alt="Protected areas" />
            <figcaption>
              Protected areas used as a proxy for low-impact, durable habitat. Green polygons represent
              lands with medium or high protection levels (for example national forests, state parks,
              or other conservation lands) that are favored in the cost surface as anchor areas for
              long-term connectivity.
            </figcaption>
          </figure>
        </div>
      </section>

      <!-- MODELBUILDER SECTION -->
      <section>
        <h2>ArcGIS Pro ModelBuilder implementation</h2>
        <p>
          The entire workflow is encapsulated in an ArcGIS Pro ModelBuilder model (schematized below)
          that mirrors the Learn ArcGIS “Build a Model to Connect Mountain Lion Habitat” exercise.
          The model groups preprocessing, cost-surface creation, and least-cost path extraction into
          modular sub-models that can be re-run or modified without rebuilding the analysis from scratch.
        </p>

        <figure>
          <img src="model.png" alt="ArcGIS Pro ModelBuilder diagram for mountain lion corridor analysis" />
          <figcaption>
            <strong>ModelBuilder diagram.</strong> The left-hand group handles data preparation and
            feature-to-raster conversion (for example, rasterizing roads and computing elevation-derived
            terrain metrics). The central group builds the composite cost surface by rescaling and
            reclassifying distance-to-roads, land cover, ruggedness, and protection status, then combining
            them with a weighted overlay. The right-hand group uses the resulting cost raster and core
            habitat features as inputs to <em>Optimal Region Connections</em>, producing a least-cost
            corridor network that is later evaluated and exported for web visualization.
          </figcaption>
        </figure>
      </section>
    </main>
  </div>

  <script>
    mapboxgl.accessToken =
      "pk.eyJ1IjoicXR5cmVlIiwiYSI6ImNtaHl5eHNmeDBoY3oybXEwNTIxNGgxYmsifQ.VqoAKKHQxQX-lNNPwVKHmw";

    const centerLon = -118.5426;
    const centerLat = 34.3917;
    const projectBounds = [
      [centerLon - 1.0, centerLat - 1.0],
      [centerLon + 1.0, centerLat + 1.0]
    ];

    /* =========================
       MAIN CONNECTIVITY MAP
       ========================= */
    const mainMap = new mapboxgl.Map({
      container: "main-map",
      style: "mapbox://styles/mapbox/outdoors-v12",
      center: [centerLon, centerLat],
      zoom: 9
    });

    mainMap.addControl(new mapboxgl.NavigationControl(), "top-left");
    mainMap.addControl(
      new mapboxgl.ScaleControl({ maxWidth: 150, unit: "metric" })
    );

    const LAYER_IDS_MAIN = {
      cost: "cost-raster-layer",
      corridorFill: "corridor-fill-layer",
      corridorOutline: "corridor-outline-layer",
      habitatFill: "habitat-fill-layer",
      habitatLabels: "habitat-label-layer"
    };

    mainMap.on("load", () => {
      mainMap.fitBounds(projectBounds, { padding: 20 });

      // Find first symbol layer to insert cost raster below labels
      let firstSymbolId = null;
      for (const layer of mainMap.getStyle().layers) {
        if (layer.type === "symbol") {
          firstSymbolId = layer.id;
          break;
        }
      }

      // Cost raster tileset
      mainMap.addSource("cost-raster-source", {
        type: "raster",
        url: "mapbox://qtyree.brherocl",
        tileSize: 256
      });

      const costLayerDef = {
        id: LAYER_IDS_MAIN.cost,
        type: "raster",
        source: "cost-raster-source",
        paint: {
          "raster-opacity": 1.0,
          "raster-resampling": "linear",
          "raster-color-range": [0, 1],
          "raster-color": [
            "interpolate",
            ["linear"],
            ["raster-value"],
            0.0, "#006837",
            0.5, "#ffff00",
            1.0, "#ff0000"
          ]
        }
      };
      if (firstSymbolId) {
        mainMap.addLayer(costLayerDef, firstSymbolId);
      } else {
        mainMap.addLayer(costLayerDef);
      }

      // Corridor
      mainMap.addSource("corridor-source", {
        type: "vector",
        url: "mapbox://qtyree.47shkbji"
      });

      mainMap.addLayer({
        id: LAYER_IDS_MAIN.corridorFill,
        type: "fill",
        source: "corridor-source",
        "source-layer": "coordidor-af1k30",
        paint: {
          "fill-color": "#1f78ff",
          "fill-opacity": 0.7
        }
      });

      mainMap.addLayer({
        id: LAYER_IDS_MAIN.corridorOutline,
        type: "line",
        source: "corridor-source",
        "source-layer": "coordidor-af1k30",
        paint: {
          "line-color": "#0044aa",
          "line-width": 2
        }
      });

      // Core habitats
      mainMap.addSource("habitat-source", {
        type: "vector",
        url: "mapbox://qtyree.3ghp614p"
      });

      mainMap.addLayer({
        id: LAYER_IDS_MAIN.habitatFill,
        type: "fill",
        source: "habitat-source",
        "source-layer": "Habitat-42p43c",
        paint: {
          "fill-color": "#ffff00",
          "fill-opacity": 0.8,
          "fill-outline-color": "#000000"
        }
      });

      mainMap.addLayer({
        id: LAYER_IDS_MAIN.habitatLabels,
        type: "symbol",
        source: "habitat-source",
        "source-layer": "Habitat-42p43c",
        layout: {
          "text-field": ["get", "Name"],
          "text-size": 11,
          "text-font": ["Open Sans Semibold", "Arial Unicode MS Bold"],
          "text-offset": [0, 0.6],
          "text-anchor": "top"
        },
        paint: {
          "text-color": "#000000",
          "text-halo-color": "rgba(255, 255, 255, 0.8)",
          "text-halo-width": 1.2
        }
      });

      function setVisibilityMain(id, visible) {
        if (!mainMap.getLayer(id)) return;
        mainMap.setLayoutProperty(
          id,
          "visibility",
          visible ? "visible" : "none"
        );
      }

      document.getElementById("toggle-cost")
        .addEventListener("change", (e) => {
          setVisibilityMain(LAYER_IDS_MAIN.cost, e.target.checked);
        });

      document.getElementById("toggle-corridor")
        .addEventListener("change", (e) => {
          const v = e.target.checked;
          setVisibilityMain(LAYER_IDS_MAIN.corridorFill, v);
          setVisibilityMain(LAYER_IDS_MAIN.corridorOutline, v);
        });

      document.getElementById("toggle-habitat")
        .addEventListener("change", (e) => {
          setVisibilityMain(LAYER_IDS_MAIN.habitatFill, e.target.checked);
        });

      document.getElementById("toggle-habitat-labels")
        .addEventListener("change", (e) => {
          setVisibilityMain(LAYER_IDS_MAIN.habitatLabels, e.target.checked);
        });
    });

    /* =========================
       DISTANCE TO ROADS MAP
       ========================= */
    const distanceMap = new mapboxgl.Map({
      container: "distance-map",
      style: "mapbox://styles/mapbox/dark-v11",
      center: [centerLon, centerLat],
      zoom: 9
    });

    distanceMap.addControl(new mapboxgl.NavigationControl(), "top-left");

    distanceMap.on("load", () => {
      distanceMap.fitBounds(
        [
          [-119.1034088, 33.9992943],
          [-118.0966949, 34.6758995]
        ],
        { padding: 20 }
      );

      // Distance raster
      distanceMap.addSource("distance-raster", {
        type: "raster",
        url: "mapbox://qtyree.2yy32lf4",
        tileSize: 256
      });

      distanceMap.addLayer({
        id: "distance-raster-layer",
        type: "raster",
        source: "distance-raster",
        paint: {
          "raster-opacity": 0.9,
          "raster-resampling": "linear",
          "raster-color": [
            "interpolate",
            ["linear"],
            ["raster-value"],
            0.0, "#440154",
            0.25, "#31688e",
            0.5, "#35b779",
            0.75, "#fde725",
            1.0, "#ffffe0"
          ]
        }
      });

      // Roads vector using new tileset
      distanceMap.addSource("roads-simplified", {
        type: "vector",
        url: "mapbox://qtyree.2a3apja8"
      });

      distanceMap.addLayer({
        id: "roads-layer",
        type: "line",
        source: "roads-simplified",
        "source-layer": "roads_simplified_z8_15-a98ep0",
        paint: {
          "line-color": "#ffffff",
          "line-width": 1.5
        }
      });

      // Roads toggle
      const roadsCheckbox = document.getElementById("toggle-roads");
      function setRoadsVisibility(visible) {
        if (!distanceMap.getLayer("roads-layer")) return;
        distanceMap.setLayoutProperty(
          "roads-layer",
          "visibility",
          visible ? "visible" : "none"
        );
      }

      // Initialize based on checkbox state
      setRoadsVisibility(roadsCheckbox.checked);

      roadsCheckbox.addEventListener("change", (e) => {
        setRoadsVisibility(e.target.checked);
      });
    });
  </script>
</body>
</html>
